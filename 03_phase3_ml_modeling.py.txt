"""
Phase 3 — Machine Learning Modeling (Baseline Surrogate)
Trains a RandomForest on Phase 2 features to predict nodal pressure.
Saves parity plot and feature importances to output/Phase3/.
"""
import os, pandas as pd, matplotlib.pyplot as plt
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.metrics import r2_score, mean_absolute_error, mean_squared_error
from sklearn.ensemble import RandomForestRegressor

ROOT = os.path.abspath(os.path.dirname(__file__))
IN   = os.path.join(ROOT, "output", "Phase2", "phase2_features.csv")
OUT  = os.path.join(ROOT, "output", "Phase3")
os.makedirs(OUT, exist_ok=True)

df = pd.read_csv(IN, encoding="utf-8-sig")
y_col = [c for c in df.columns if c.lower().startswith("pressure")][0]
y = df[y_col]; X = df.drop(columns=[y_col])

Xtr, Xte, ytr, yte = train_test_split(X, y, test_size=0.3, random_state=42)
rf = RandomForestRegressor(random_state=42)
param = {"n_estimators":[300,500], "min_samples_leaf":[1,2]}
gs = GridSearchCV(rf, param, cv=3, n_jobs=-1, scoring="r2"); gs.fit(Xtr, ytr)
best = gs.best_estimator_; yp = best.predict(Xte)

r2 = r2_score(yte, yp); mae = mean_absolute_error(yte, yp); rmse = mean_squared_error(yte, yp, squared=False)
print({"R2":r2, "RMSE":rmse, "MAE":mae})

fi = pd.Series(best.feature_importances_, index=X.columns).sort_values(ascending=False)
fi.to_csv(os.path.join(OUT,"rf_feature_importance.csv"))

plt.figure(figsize=(5,5)); plt.scatter(yte, yp, s=12, alpha=0.7)
mn, mx = min(yte.min(), yp.min()), max(yte.max(), yp.max())
plt.plot([mn,mx],[mn,mx],'k--'); plt.xlabel("Observed Pressure (m)"); plt.ylabel("Predicted (m)")
plt.title(f"RF Parity (R2={r2:.3f})"); plt.tight_layout(); plt.savefig(os.path.join(OUT,"rf_parity.png"), dpi=250); plt.close()

print("Phase 3 complete →", OUT)
